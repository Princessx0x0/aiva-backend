# Production Incident Report - Load Test Attack
**Date:** January 27, 2026  
**Duration:** ~10 minutes  
**Severity:** High (complete service outage)  
**Status:** Resolved

## Summary
External security researcher conducted authorized load testing against the `/v1/ai/insights` endpoint, resulting in Gemini API rate limit exhaustion and cascading service failure across all endpoints.

## Timeline (UTC)
- **19:43:55** - Attack begins, rapid POST requests to `/v1/ai/insights`
- **19:43:55** - First 20 requests succeed
- **19:43:55** - Gemini API rate limit hit (20 req/min free tier)
- **19:43:56** - All subsequent requests return 500 errors
- **19:44:00** - All endpoints become unresponsive (including `/health`, `/hello`)
- **19:48:00** - Attack stops
- **19:49:00** - Service gradually recovers as queued requests clear

## Root Cause Analysis

### Primary Cause
Gemini API free tier rate limit (20 requests/minute) was exhausted by rapid requests.

### Contributing Factors
1. **No circuit breaker** - Application continued attempting Gemini calls after rate limit hit
2. **High concurrency** - Default 80 concurrent requests per container allowed queue buildup
3. **No rate limiting** - No protection against rapid request bursts
4. **Slow failure mode** - Each failing request took 5-10 seconds to complete

### Cascading Failure
1. Rapid requests overwhelmed Gemini API quota
2. Each request took 5-10 seconds to fail (timeout + exception handling)
3. All 10 Cloud Run instances became saturated with failing requests
4. New requests (including to other endpoints) queued indefinitely
5. Requests exceeded 60-second Cloud Run timeout
6. Complete service outage across all endpoints

## What Worked Well
- Cloud Run auto-scaling activated correctly  
- Error logging captured all failures  
- Health endpoint design was correct (didn't call external APIs)  
- Secret Manager protected API key  
- No data loss or corruption  
- Service self-recovered after attack stopped  

## What Didn't Work
- No rate limiting on application endpoints  
- No circuit breaker for external API failures  
- Concurrency settings too high for slow endpoints  
- Error responses returned 500 instead of 429 for rate limits  
- No monitoring/alerting for rate limit exhaustion  

## Fixes Implemented

### Immediate (January 27, 2026)
- Reduced container concurrency from 80 → 5
- Verified health endpoint doesn't depend on external APIs

### Planned (This Week)
- [ ] Implement circuit breaker pattern in insights endpoint
- [ ] Add application-level rate limiting (15 req/min buffer)
- [ ] Return 429 instead of 500 for rate limit errors
- [ ] Add response caching for mock data
- [ ] Set up monitoring alerts for error rate spikes

### Planned (Next Sprint)
- [ ] Implement API Gateway with rate limiting
- [ ] Add Cloud Armor DDoS protection
- [ ] Consider Gemini API paid tier upgrade
- [ ] Separate fast/slow endpoints into different services

## Lessons Learned

### Technical
1. **External dependencies need circuit breakers** - Never continue calling a failing external service
2. **Rate limiting must be client-side** - Don't rely on external APIs to protect you
3. **Concurrency settings matter** - Default settings aren't always right
4. **Proper HTTP status codes matter** - 429 ≠ 500
5. **Load testing reveals real bottlenecks** - This was valuable 

### Process
1. **Monitoring/alerting is critical** - Should have been notified within 1 minute
2. **Incident response practice is valuable** - This was a safe environment to learn

## Cost Impact
**Total cost:** $0.00  
- Free tier quotas absorbed all usage
- No overage charges incurred
- Gemini API free tier limits prevented runaway costs

## Action Items
| Priority | Item | Owner | Status |
|----------|------|-------|--------|
| P0 | Add circuit breaker to insights endpoint | Princess | Planned |
| P0 | Implement rate limiting | Princess | Planned |
| P1 | Fix error code for rate limits (429 not 500) | Princess | Planned |
| P1 | Add monitoring/alerting | Princess | Planned |
| P2 | Cache responses for mock data | Princess | Planned |
| P2 | Consider API tier upgrade | Princess | Backlog |

## References
- Gemini API Rate Limits: https://ai.google.dev/gemini-api/docs/rate-limits
- Circuit Breaker Pattern: https://microservices.io/patterns/reliability/circuit-breaker.html
- Cloud Run Concurrency: https://cloud.google.com/run/docs/about-concurrency

---
**Report Author:** Princess Faith Okafor  
**Reviewed By:** N/A (Personal project)  
**Next Review:** After fixes implemented